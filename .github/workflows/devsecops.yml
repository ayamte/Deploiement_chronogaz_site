name: DevSecOps Security Analysis

on:
  push:
    branches: [main, develop, devsecops/vulnerable-testing]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: Static Security Analysis (SAST & SCA)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            api/package-lock.json

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq tree

      - name: Install Dependencies - Client
        working-directory: ./client
        run: npm ci --legacy-peer-deps
        continue-on-error: false

      - name: Install Dependencies - API
        working-directory: ./api
        run: npm ci --legacy-peer-deps
        continue-on-error: false

      # ===================================
      # SCA - Analyse des DÃ©pendances
      # ===================================

      - name: SCA - NPM Audit (Client - Production)
        working-directory: ./client
        run: |
          npm audit --json > ../sca-client-production.json || true
          npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: SCA - NPM Audit (Client - Vulnerable)
        working-directory: ./client
        run: |
          if [ -f "package.vulnerable.json" ]; then
            cp package.json package.json.backup
            cp package.vulnerable.json package.json
            npm install --legacy-peer-deps
            npm audit --json > ../sca-client-vulnerable.json || true
            mv package.json.backup package.json
          else
            echo '{"metadata":{"vulnerabilities":{"total":0}}}' > ../sca-client-vulnerable.json
          fi
        continue-on-error: true

      - name: SCA - NPM Audit (API - Production)
        working-directory: ./api
        run: |
          npm audit --json > ../sca-api-production.json || true
          npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: SCA - NPM Audit (API - Vulnerable)
        working-directory: ./api
        run: |
          if [ -f "package.vulnerable.json" ]; then
            cp package.json package.json.backup
            cp package.vulnerable.json package.json
            npm install --legacy-peer-deps
            npm audit --json > ../sca-api-vulnerable.json || true
            mv package.json.backup package.json
          else
            echo '{"metadata":{"vulnerabilities":{"total":0}}}' > ../sca-api-vulnerable.json
          fi
        continue-on-error: true

      - name: SCA - OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        timeout-minutes: 30
        with:
          project: 'ChronoGaz'
          path: '.'
          format: 'JSON,HTML'
          out: 'dependency-check-reports'
        continue-on-error: true

      - name: Upload SCA Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sca-reports
          path: |
            sca-client-production.json
            sca-client-vulnerable.json
            sca-api-production.json
            sca-api-vulnerable.json
            dependency-check-reports/
          retention-days: 30
          if-no-files-found: warn

      # ===================================
      # SAST - Analyse Statique du Code
      # ===================================

      - name: SAST - ESLint Security Plugin
        run: |
          set -euo pipefail
          
          echo "ðŸ“‚ Contenu du workspace:"
          ls -la
          echo ""
          echo "ðŸ“‚ Structure des rÃ©pertoires:"
          find . -type d -name "src" 2>/dev/null || echo "Aucun dossier src trouvÃ©"
          echo ""
          
          TEMP_INSTALL_DIR="/tmp/eslint-tools"
          mkdir -p "$TEMP_INSTALL_DIR"
          cd "$TEMP_INSTALL_DIR"
          
          echo "ðŸ”§ Installation locale isolÃ©e d'ESLint & plugins"
          npm init -y
          npm install eslint@8.57.0 eslint-plugin-security eslint-plugin-no-secrets --force || true
          
          export PATH="$TEMP_INSTALL_DIR/node_modules/.bin:$PATH"
          export NODE_PATH="$TEMP_INSTALL_DIR/node_modules:$NODE_PATH"
          
          echo "âœ… ESLint installÃ© Ã : $(which eslint)"
          echo "âœ… NODE_PATH configurÃ©: $NODE_PATH"
          
          cd $GITHUB_WORKSPACE
          
          cat > .eslintrc.security.json <<'EOF'
{
  "env": {"browser": true, "es2021": true, "node": true},
  "parserOptions": {
    "ecmaVersion": 2021,
    "sourceType": "module",
    "ecmaFeatures": {"jsx": true}
  },
  "plugins": ["security", "no-secrets"],
  "extends": ["plugin:security/recommended"],
  "rules": {
    "no-secrets/no-secrets": "warn",
    "security/detect-eval-with-expression": "error",
    "security/detect-unsafe-regex": "error",
    "security/detect-non-literal-fs-filename": "warn"
  }
}
EOF

          echo '[]' > sast-eslint-client.json
          echo '[]' > sast-eslint-api.json
          
          run_eslint_scan() {
            dir=$1
            out=$2
            echo ""
            echo "=========================================="
            echo "ðŸ” Scan de: $dir"
            echo "=========================================="
            
            if [ -d "$dir" ]; then
              echo "âœ… RÃ©pertoire existe"
              echo "ðŸ“ Contenu de $dir:"
              ls -la "$dir" || true
              
              # Trouver tous les fichiers JS/JSX
              echo ""
              echo "ðŸ”Ž Recherche de fichiers JS/JSX..."
              find "$dir" -type f \( -name "*.js" -o -name "*.jsx" \) -print > /tmp/files_to_scan.txt
              
              echo "ðŸ“Š Nombre de fichiers trouvÃ©s: $(wc -l < /tmp/files_to_scan.txt)"
              
              if [ -s /tmp/files_to_scan.txt ]; then
                echo "ðŸ“„ Liste des fichiers:"
                cat /tmp/files_to_scan.txt
                
                echo ""
                echo "ðŸš€ Lancement d'ESLint..."
                # Scanner avec ESLint - spÃ©cifier le resolve-plugins-relative-to
                xargs -a /tmp/files_to_scan.txt eslint \
                  --config .eslintrc.security.json \
                  --resolve-plugins-relative-to "$TEMP_INSTALL_DIR" \
                  --format json \
                  --output-file "$out" 2>&1 || true
                
                echo "ðŸ“ Taille du rapport: $(stat -c%s "$out" 2>/dev/null || echo 0) bytes"
                echo "ðŸ“„ Contenu du rapport:"
                head -c 500 "$out" 2>/dev/null || echo "Fichier vide ou introuvable"
              else
                echo "âš ï¸ Aucun fichier JS/JSX trouvÃ© dans $dir"
                echo '[]' > "$out"
              fi
            else
              echo "âŒ RÃ©pertoire $dir introuvable"
              echo '[]' > "$out"
            fi

            # Valider le JSON
            if ! jq -e . "$out" >/dev/null 2>&1; then
              echo "âš ï¸ $out n'est pas un JSON valide. RÃ©initialisation."
              echo '[]' > "$out"
            fi
            
            echo "âœ… Rapport final: $out ($(stat -c%s "$out" 2>/dev/null || echo 0) bytes)"
          }

          run_eslint_scan client/src sast-eslint-client.json
          run_eslint_scan api/src sast-eslint-api.json

          echo "âœ… Final Client: $(stat -c%s sast-eslint-client.json 2>/dev/null || echo 0) bytes"
          echo "âœ… Final API: $(stat -c%s sast-eslint-api.json 2>/dev/null || echo 0) bytes"
        continue-on-error: true

      - name: Upload SAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-reports
          path: |
            sast-eslint-client.json
            sast-eslint-api.json
          retention-days: 30
          if-no-files-found: warn

  # ====================================================================
  # Job DAST - Ajoutez votre job dast-scan ici
  # ====================================================================